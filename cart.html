<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>购物车</title>
    <link rel="stylesheet" href="./css/home.css">
    <link rel="stylesheet" href="./css/cart.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>

<body>
    <div class="app">
        <div class="header">
            <div class="header-tpbar">
                <div class="container">
                    <div class="tpbar-nav">
                        <a href="index.html">小米商城</a>
                        <span class="sep">|</span>
                        <a href="list.html">小米列表</a>
                        <span class="sep">|</span>
                        <a href="cart.html">小米购物车</a>
                        <span class="sep">|</span>
                        <a href="buy.html">小米支付</a>
                        <span class="sep">|</span>
                        <a href="#" class="tpbar-download">下载APP
                            <span class="appcode">
                                <img src="./pic/download.png" alt="小米商城" width="90px" height="90px">
                                小米商城APP
                            </span>
                        </a>
                        <span class="sep">|</span>
                        <a href="#">ARE YOU OK</a>
                        <span class="sep">|</span>
                    </div>
                    <div class="tpbar-info">
                        <a class="link" href="login.html">登录</a>
                        <span class="sep">|</span>
                        <a class="link" href="register.html">注册</a>
                    </div>
                    <div class="tpbar-self">
                        <span class="sep">|</span>
                        <dpan href="javascript:;" class="link" id="infoSelf"></dpan>
                        <span href="javascript:;" class="btn btn-primary btn-xs" id="logout">退出</span>
                        <span class="sep">|</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mi-cart">
            <center>
                <h2>购物车页面</h2>
            </center>
            <div class="container" id="content">
                <p id="cart-no">您的购物车现在空空如也,请来<a href='list.html'>小米列表</a>挑选你喜欢的商品加入购物车吧！</p>
                <table width="100%" id="tab">
                    <thead>
                        <tr>
                            <th><input type="checkbox" class="all">全选</th>
                            <th>商品名称</th>
                            <th>商品图片</th>
                            <th>商品颜色</th>
                            <th>商品类型</th>
                            <th>商品价格</th>
                            <th>商品数量</th>
                            <th>合计</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>请稍等，数据加载中....</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th><input type="checkbox" class="all">全选</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>商品总数：<span class="totalNum"></span></th>
                            <th>商品总价：<span class="totalPrice"></span></th>
                            <th><a href="buy.html" class="buyAll btn btn-info" id="buyAll">立即支付</a><span
                                    class="btn btn-danger" style="margin-left: 15px;" id="removeAll">清空购物车</span></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="mi-login">
            <center>
                <h2>请先登录</h2>
            </center>
            <div class="container">
                <a href="login.html" class="btn btn-primary btn-lg">登录</a>
                <a href="register.html" class="btn btn-primary btn-lg">注册</a>
            </div>
        </div>

        <div class="footer">
            <div class="footer-list">
                <div class="footer-service">
                    <ul class="list-service clearfix">
                        <li><a href="#">预约维修服务</a></li>
                        <li><a href="#">7天无理由退货</a></li>
                        <li><a href="#">15天免费换货</a></li>
                        <li><a href="#">满99元包邮</a></li>
                        <li><a href="#">520余家售后网点</a></li>
                    </ul>
                </div>
                <div class="footer-links clearfix">
                    <dl class="col-links col-links-first">
                        <dt>帮助中心</dt>
                        <dd><a href="#">账户管理</a></dd>
                        <dd><a href="#">购物指南</a></dd>
                        <dd><a href="#">订单操作</a></dd>
                    </dl>

                    <dl class="col-links ">
                        <dt>服务支持</dt>
                        <dd><a href="#">售后政策</a></dd>
                        <dd><a href="#">自助服务</a></dd>
                        <dd><a href="#">相关下载</a></dd>
                    </dl>

                    <dl class="col-links ">
                        <dt>线下门店</dt>
                        <dd><a href="#">小米之家</a></dd>
                        <dd><a href="#">服务网点</a></dd>
                        <dd><a href="#">授权体验店</a></dd>
                    </dl>

                    <dl class="col-links ">
                        <dt>关于小米</dt>
                        <dd><a href="#">了解小米</a></dd>
                        <dd><a href="#">加入小米</a></dd>
                        <dd><a href="#">投资者关系</a></dd>
                        <dd><a href="#">廉洁举报</a></dd>
                    </dl>

                    <dl class="col-links ">
                        <dt>关注我们</dt>
                        <dd><a href="#">新浪微博</a></dd>
                        <dd><a href="#" id="J_siteWeixinCode">官方微信</a></dd>
                        <dd><a href="#">联系我们</a></dd>
                        <dd><a href="#">公益基金会</a></dd>
                    </dl>

                    <dl class="col-links ">
                        <dt>特色服务</dt>
                        <dd><a href="#" _blank">F 码通道</a></dd>
                        <dd><a href="#">礼物码</a></dd>
                        <dd><a href="#" _blank">防伪查询</a></dd>
                    </dl>

                    <div class="col-contact">
                        <p class="phone">XXX-XXX-XXXX</p>
                        <p>8:00-18:00（仅收市话费）</p>
                        <p>人工客服:XXXX-XXXXXXXX</p>
                        <div class="follow">关注小米：<a href="#" class="wb"></a><a class="wx" href="#"></a> <img
                                src="pic/wx-img.png">
                        </div>
                    </div>
                </div>
                <hr>
            </div>
            <div class="footer-bn">
                <div class="logo"></div>
                <div class="info-text">
                    <p class="sites">
                        <a href="#">小米商城</a>
                        <span class="sep">|</span>
                        <a href="#">MIUI</a>
                        <span class="sep">|</span>
                        <a href="#">米家</a>
                        <span class="sep">|</span>
                        <a href="#">米聊</a>
                        <span class="sep">|</span>
                        <a href="#">多看</a>
                        <span class="sep">|</span>
                        <a href="#">游戏</a>
                        <span class="sep">|</span>
                        <a href="#">政企服务</a>
                        <span class="sep">|</span>
                        <a href="#">小米天猫店</a>
                        <span class="sep">|</span>
                        <a href="#">小米集团隐私政策</a>
                        <span class="sep">|</span>
                        <a href="#">小米公司儿童信息保护规则</a>
                        <span class="sep">|</span>
                        <a href="#">小米商城隐私政策</a>
                        <span class="sep">|</span>
                        <a href="#">小米商城用户协议</a>
                        <span class="sep">|</span>
                        <a href="#">问题反馈</a>
                    </p>
                    <br>
                    <p>
                        &copy;
                        <a href="#" title="mi.com">mi.com</a> 京ICP证110507号
                        <a href="#">京ICP备10046444号</a>
                        <a href="#">京公网安备11010802020134号</a>
                        <a href="#">京网文[2020]0276-042号</a>
                        <br>
                        <a href="#">（京）网械平台备字（2018）第00005号</a>
                        <a href="#">互联网药品信息服务资格证 (京)-非经营性-2014-0090</a>
                        <a href="#">营业执照</a>
                        <a href="#">医疗器械质量公告</a>
                        <br>
                        <a href="#">增值电信业务许可证</a>&nbsp;网络食品经营备案（京）【2018】WLSPJYBAHF-12&nbsp;
                        <a href="#">食品经营许可证</a>
                        <br>
                        违法和不良信息举报电话：185-0130-1238&nbsp;<a href='#'>知识产权侵权投诉</a>&nbsp;本网站所列数据，除特殊说明，所有数据均出自我司实验室测试
                    </p>
                </div>
                <div class="info-links">
                    <a href="#">
                        <img src="pic/truste.png" alt="TRUSTe Privacy Certification">
                    </a>
                    <a href="#">
                        <img src="pic/v-logo-2.png" alt="诚信网站">
                    </a>
                    <a href="#">
                        <img src="pic/v-logo-1.png" alt="可信网站">
                    </a>
                    <a href="#">
                        <img src="pic/ba10428a4f9495ac310fd0b5e0cf8370.png" alt="诚信经营 放心消费">
                    </a>
                </div>
                <div class="slogan"></div>
            </div>
        </div>
    </div>
</body>


<script src="./js/jquery-3.4.1.min.js"></script>
<script src="./js/promiseAjax.js"></script>
<script src="./js/cookie.js"></script>
<script>
    /*是否登录判断*/
    var username = getCookie("username");
    if (username) {
        $("#infoSelf").html(username + "用户");
        $(".tpbar-info").css("display", "none");
        $(".tpbar-self").css("display", "block");
        $(".mi-login").css("display", "none");
        $(".mi-cart").css("display", "block");
        $("#logout").click(function () {
            removeCookie("username");
            $(".tpbar-info").css("display", "block");
            $(".tpbar-self").css("display", "none");
            location.reload();
        });
        var data = localStorage.getItem("data");
        if (data) {
            $(".msg").css("display", "none");
            $(".msg2").css("display", "block");
            data = JSON.parse(data);
            var numArr = data.map(function(v){
                return v.number
            });
            var sum = numArr.reduce(function(a,b){
                return a+b;
            });
            $(".msg2-num").html(sum);
        } else {
            $(".msg").css("display", "block");
            $(".msg2").css("display", "none");
        }
    } else {
        $(".tpbar-info").css("display", "block");
        $(".mi-login").css("display", "block");
        $(".mi-cart").css("display", "none");
    }
    /*提取浏览器储存数据*/
    var data = localStorage.getItem("data");

    if (!data || data == "[]") {
        $("#tab").css("visibility", "hidden");
        $("#cart-no").css("display", "block");
    } else {
        $("#tab").css("visibility", "visible");
        $("#cart-no").css("display", "none");
        data = JSON.parse(data);
        var arr = data.map(function (v) {
            return v.id;
        });
        var ids = arr.join(",");
        $.ajax({
            url: "./server/cart.php",
            data: {
                ids: ids
            },
            type: "post",
            dataType: "json",
            success: function (res) {
                if (res.status == 200) {
                    res = res.data;
                    var str = '';
                    for (var i = 0; i < res.length; i++) {
                        var data1 = data.filter(function (v) {
                            return v.id == res[i].id;
                        });
                        var number = data1[0].number;
                        var checkColor = data1[0].checkColor;
                        var checkType = data1[0].checkType;
                        str += `
                            <tr data-id="${res[i].id}">
                                <td class="checkOne"><input type="checkbox" class="one"></td>
                                <td>${res[i].name}</td>
                                <td><img src="${res[i].imgpath}" width="50" height="50"></td>
                                <td>${checkColor}</td>
                                <td>${checkType}</td>
                                <td>${res[i].price}</td>
                                <td>
                                    <button class="jian btn btn-default">-</button>
                                    <input type="number" name="number" value="${number}" data-stock="${res[i].stock}">
                                    <button class="add btn btn-default">+</button>
                                </td>
                                <td>${res[i].price * number}</td>
                                <td><button class="remove btn btn-default">删除购物车</button></td>
                            </tr>
                        `;
                        $("tbody").html(str);
                        /*全选单击事件*/
                        $(".all").click(function () {
                            if ($(this).prop("checked")) {
                                $(".one").prop("checked", true);
                                $(".all").prop("checked", true);
                            } else {
                                $(".one").prop("checked", false);
                                $(".all").prop("checked", false);
                            }
                            total();
                        });
                        /*单个复选框单击事件*/
                        $(".one").click(function () {
                            var choose = Array.prototype.slice.call($(".one")).every(function (v) {
                                return $(v).prop("checked");
                            });
                            if (choose) {
                                $(".all").prop("checked", true);
                            } else {
                                $(".all").prop("checked", false);
                            }
                            total();
                        });
                        /*商品数量加*/
                        $(".add").click(function () {
                            $(this).prev().val($(this).prev().val() - 0 + 1);
                            var stock = $(this).prev().attr("data-stock");
                            if ($(this).prev().val() - 0 >= stock) {
                                $(this).prev().val(stock);
                            }
                            var that = $(this);
                            var brr = data.find(function (v) {
                                return v.id == that.parent().parent().attr("data-id");
                            });
                            brr.number = $(this).prev().val() - 0;
                            localStorage.setItem("data", JSON.stringify(data));
                            total();
                        });
                        /*商品数量减*/
                        $(".jian").click(function () {
                            $(this).next().val($(this).next().val() - 1);
                            if ($(this).next().val() - 0 <= 1) {
                                $(this).next().val(1);
                            }
                            var that = $(this);
                            var brr = data.find(function (v) {
                                return v.id == that.parent().parent().attr("data-id");
                            });
                            brr.number = $(this).next().val() - 0;
                            localStorage.setItem("data", JSON.stringify(data));
                            total();
                        });
                        /*单个删除购物车*/
                        $(".remove").click(function () {
                            var that = $(this);
                            var index = data.findIndex(function (v) {
                                return v.id == that.parent().parent().attr("data-id");
                            });
                            data.splice(index, 1);
                            localStorage.setItem("data", JSON.stringify(data));
                            $(this).parent().parent().remove();
                            if (data.length == 0) {
                                $("#tab").css("visibility", "hidden");
                                $("#cart-no").css("display", "block");
                            }
                        });
                    }
                }
            }
        });
        $(window).ajaxStop(function () {
            /*支付单击事件*/
            $("#buyAll").click(function () {
                var allPrice = $("#buyAll").parent().prev().children().text();
                if (allPrice == "" || allPrice == 0) {
                    alert("请选择您要支付的商品！");
                    location.reload();
                    return false;
                }
                var allPrice = allPrice.trim();
                setCookie("allprice", allPrice, 7200);
            });
            /*清空购物车*/
            $("#removeAll").click(function () {
                var flag = confirm("您确认要清空您的购物车？");
                if (flag) {
                    localStorage.removeItem("data");
                    location.reload();
                } else {
                    return;
                }
            });
        });
    }
    /*计数计算，总数，总价*/
    function total() {
        var totalNum = 0;
        var totalPrice = 0;
        $("[name='number']").each(function (i, v) {
            $(v).parent().next().text($(v).val() * $(v).parent().prev().text());
            if ($(v).parent().siblings(".checkOne").children(".one").prop("checked")) {
                totalNum += $(v).val() - 0;
                totalPrice += $(v).parent().next().text() - 0;
            }
        });
        $(".totalNum").text(totalNum);
        $(".totalPrice").text(totalPrice);
    }
</script>

</html>